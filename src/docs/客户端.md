# AI客户端设计与实现规范

## 1. 设计目标

1. 实现统一的AI客户端接口，支持多种AI平台
2. 提供简洁易用的API，隐藏底层实现复杂性
3. 良好处理EventStream返回流，提供一致的使用体验
4. 将共同能力和重复功能放在父类实现，避免重复工作

## 2. 通义千问客户端实现

### 2.1 核心功能

通义千问客户端实现了以下核心功能：

1. **会话管理**
   - 创建会话：`createSession()`
   - 删除会话：`deleteSession(sessionId)`

2. **消息发送**
   - 发送普通消息：`sendMessage(message, options)`
   - 发送系统消息：`sendSystemMessage(message, options)`

3. **模型管理**
   - 获取模型列表：`getModels()`
   - 选择模型：`selectModel(modelCode)`
   - 获取当前模型：`getCurrentModel()`
   - 获取可用模型列表：`getAvailableModels()`

4. **用户信息**
   - 获取用户信息：`getUserInfo()`

### 2.2 API设计原则

1. **简洁性**：API设计简洁明了，易于使用
2. **一致性**：所有AI客户端遵循相同的接口规范
3. **可扩展性**：支持平台特定的扩展功能
4. **错误处理**：统一的错误处理机制

### 2.3 EventStream处理

通义千问客户端对EventStream的处理具有以下特点：

1. **流式响应**：返回`AsyncIterable<string>`，支持异步迭代
2. **错误处理**：完善的错误处理机制，区分不同类型的错误
3. **超时控制**：支持请求超时设置
4. **资源管理**：自动管理流资源，确保正确释放

## 3. 继承关系与代码复用

### 3.1 基类设计

所有AI客户端继承自`BaseAIClient`抽象类，该类提供了：

1. **通用属性**：
   - `credentials`：认证信息
   - `platform`：平台类型
   - `baseUrl`：基础URL
   - `sessionID`：会话ID

2. **通用方法**：
   - `generateUUID()`：生成UUID
   - `generateTimestamp()`：生成时间戳
   - `setCredentials()`：设置认证信息

3. **抽象方法**：
   - `sendMessage()`：发送消息（需子类实现）
   - `getUserInfo()`：获取用户信息（需子类实现）
   - `extractCredentialsFromCookies()`：从cookie提取认证信息（需子类实现）

### 3.2 子类实现

通义千问客户端通过继承基类，只需实现特定平台的逻辑，避免重复工作：

1. **认证处理**：提取和使用平台特定的认证信息
2. **API调用**：实现平台特定的API调用逻辑
3. **数据解析**：处理平台特定的响应格式

## 4. 使用示例

```typescript
// 创建客户端实例
const credentials: ClientCredentials = {
  cookies: "your_cookies_here",
  xsrfToken: "your_xsrf_token",
  sessionId: "your_session_id"
};

const tongyiClient = new TongyiClient(credentials);

// 创建会话
const sessionId = await tongyiClient.createSession();

// 获取可用模型列表
const models = await tongyiClient.getAvailableModels();
console.log("Available models:", models);

// 选择模型（发送消息前必须确认模型已选择）
const modelSelected = await tongyiClient.selectModel("tongyi-qwen3-plus-model");
if (!modelSelected) {
  throw new Error("Failed to select model");
}

// 发送普通消息
const messageStream = await tongyiClient.sendMessage("你好，通义千问！");
for await (const chunk of messageStream) {
  console.log(chunk);
}

// 发送系统消息
const systemMessageStream = await tongyiClient.sendSystemMessage("系统提示信息");
for await (const chunk of systemMessageStream) {
  console.log(chunk);
}

// 删除会话
await tongyiClient.deleteSession(sessionId);
```

## 5. 错误处理

客户端提供了完善的错误处理机制：

1. **网络错误**：处理网络连接问题
2. **超时错误**：支持请求超时设置
3. **认证错误**：处理认证失败情况
4. **服务器错误**：处理服务器返回的错误状态码
5. **模型选择错误**：处理模型不存在或不可用的情况

## 6. 模型管理要求

### 6.1 模型选择确认

在发送消息之前，**必须**确认模型已经选择。客户端应遵循以下流程：

1. 获取可用模型列表
2. 选择合适的模型
3. 验证模型选择是否成功
4. 发送消息

### 6.2 模型验证

客户端在选择模型时会自动验证模型是否可用，确保选择的模型在服务端存在且可访问。

## 7. 扩展性

客户端设计考虑了扩展性，支持：

1. **新平台支持**：通过继承基类快速实现新平台客户端
2. **功能扩展**：在不影响现有功能的前提下添加新特性
3. **配置定制**：支持平台特定的配置选项