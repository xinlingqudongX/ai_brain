# 聊天系统重构说明

## 项目目标变更

项目已从原来的智能体管理系统重构为AI聊天系统，提供简洁的聊天界面和强大的AI对话功能。

## 重构内容

### 1. 后端重构

#### 新增数据库实体

**会话实体** (`src/entities/chat_session.entity.ts`)
- 管理聊天会话的基本信息
- 字段：id, session_name, created_at, updated_at

**消息实体** (`src/entities/chat_message.entity.ts`)
- 存储聊天消息内容
- 字段：id, session_id, role, content, tool_calls, tokens, execution_time, created_at, updated_at
- 支持用户消息、AI回复和系统消息

#### LLM模块重构

**服务层** (`src/modules/llm/llm.service.ts`)
- 集成AI Core进行消息处理
- 提供完整的会话管理功能
- 支持消息历史记录和上下文管理
- 实现工具调用结果记录

**控制器** (`src/modules/llm/llm.controller.ts`)
- 提供RESTful API接口
- 支持会话CRUD操作
- 支持消息发送和历史查询
- 集成Swagger文档

**DTO定义** (`src/modules/llm/dto/chat.dto.ts`)
- 使用Zod进行参数验证
- 完整的类型定义和响应格式

#### API接口列表

| 接口 | 方法 | 描述 |
|------|------|------|
| `/llm/action/send-message` | POST | 发送消息并获取AI回复 |
| `/llm/action/create-session` | POST | 创建新会话 |
| `/llm/action/get-sessions` | POST | 获取会话列表 |
| `/llm/action/get-session` | POST | 获取会话详情 |
| `/llm/action/update-session` | POST | 更新会话信息 |
| `/llm/action/delete-session` | POST | 删除会话 |
| `/llm/action/get-messages` | POST | 获取消息列表 |
| `/llm/action/clear-messages` | POST | 清空会话消息 |
| `/llm/action/get-models` | POST | 获取可用模型列表 |

### 2. 前端重构

#### 界面设计

**左侧会话列表**
- 按日期分组显示会话（今天、昨天、更早）
- 显示会话名称、最后消息预览、时间
- 支持会话重命名和删除
- 新建对话按钮

**右侧聊天区域**
- 欢迎界面（未选择会话时）
- 聊天头部（会话名称、消息数量、操作按钮）
- 消息列表（用户消息、AI回复、工具调用结果）
- 输入框（支持多行输入、快捷键发送）

#### 核心组件

**Chat.vue** (`frontend/src/views/Chat.vue`)
- 主聊天界面组件
- 响应式设计，适配不同屏幕尺寸
- 实时消息更新和滚动
- 支持Markdown渲染

**API封装** (`frontend/src/api/chat.ts`)
- 完整的API调用封装
- 请求/响应拦截器
- 错误处理和日志记录

**类型定义** (`frontend/src/types/chat.ts`)
- TypeScript类型定义
- 确保类型安全

#### 功能特性

- ✅ 会话管理（创建、重命名、删除）
- ✅ 消息发送和接收
- ✅ 实时打字指示器
- ✅ 工具调用结果展示
- ✅ 消息时间戳和执行时间
- ✅ 响应式设计
- ✅ 键盘快捷键支持
- ✅ 自动滚动到底部
- ✅ 消息清空功能

### 3. 技术栈

#### 后端技术
- **框架**: NestJS + Fastify
- **数据库**: PostgreSQL + TypeORM
- **验证**: Zod + nestjs-zod
- **文档**: Swagger
- **AI集成**: AI Core + DeepSeek Client

#### 前端技术
- **框架**: Vue 3 + TypeScript
- **路由**: Vue Router 4
- **HTTP**: Axios
- **样式**: Tailwind CSS
- **图标**: Heroicons
- **构建**: Vite

### 4. 数据流程

#### 消息发送流程
1. 用户在前端输入消息
2. 前端调用 `/llm/action/send-message` API
3. 后端保存用户消息到数据库
4. 后端调用AI Core处理消息
5. AI Core调用DeepSeek API获取回复
6. 如需要，执行工具调用
7. 后端保存AI回复到数据库
8. 返回完整的对话结果给前端
9. 前端更新界面显示新消息

#### 会话管理流程
1. 用户创建新会话或选择现有会话
2. 前端加载会话的消息历史
3. 用户可以重命名或删除会话
4. 所有操作实时同步到数据库

### 5. 部署说明

#### 后端部署
```bash
# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，配置数据库和API密钥

# 启动开发服务器
npm run start:dev
```

#### 前端部署
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

### 6. 环境变量配置

```env
# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/ai_brain

# AI API配置
DEEPSEEK_API_KEY=your_deepseek_api_key
TONGYI_COOKIES=your_tongyi_cookies

# 服务器配置
PORT=3000
NODE_ENV=development
```

### 7. 特色功能

#### AI集成
- 支持DeepSeek和通义千问模型
- 工具调用功能（文件系统操作等）
- 上下文记忆和对话历史
- 执行时间和Token使用统计

#### 用户体验
- 现代化的暗色主题界面
- 流畅的动画和交互效果
- 响应式设计，支持移动端
- 键盘快捷键支持

#### 数据管理
- 完整的会话和消息持久化
- 按日期分组的会话列表
- 消息搜索和过滤（可扩展）
- 数据导出功能（可扩展）

### 8. 后续扩展计划

#### 功能扩展
- [ ] 消息搜索功能
- [ ] 会话导出/导入
- [ ] 多模型切换
- [ ] 语音输入/输出
- [ ] 图片上传和识别
- [ ] 插件市场

#### 技术优化
- [ ] 消息流式传输
- [ ] 离线消息缓存
- [ ] 性能监控和分析
- [ ] 多语言支持
- [ ] 主题自定义

### 9. 总结

本次重构将项目从复杂的智能体管理系统简化为专注的AI聊天系统，提供了：

- 🎯 **专注的用户体验**: 简洁直观的聊天界面
- 🚀 **强大的AI能力**: 集成多种AI模型和工具调用
- 💾 **完整的数据管理**: 会话和消息的持久化存储
- 🔧 **可扩展的架构**: 模块化设计，易于扩展新功能
- 📱 **现代化的界面**: 响应式设计，支持多设备访问

这个新的聊天系统为用户提供了更加专注和高效的AI交互体验。