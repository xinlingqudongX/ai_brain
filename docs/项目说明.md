# AI Brain 项目说明

## 项目概述

AI Brain 是一个基于 NestJS 的 AI 角色和能力管理平台。系统允许定义不同的 AI 角色(如 DBA、开发者等)及其关联的能力,每个角色和能力都有自定义的提示词。

## 已实现功能

### 1. 角色管理模块 (Roles)
- 创建角色:定义角色名称、描述和提示词
- 查询角色:支持分页和搜索
- 更新角色:修改角色信息和关联能力
- 删除角色:移除不需要的角色
- 能力关联:为角色分配多个能力

### 2. 能力管理模块 (Capabilities)
- 创建能力:定义能力名称、描述和提示词
- 查询能力:支持分页和搜索
- 更新能力:修改能力信息
- 删除能力:移除不需要的能力
- 角色关联:查看哪些角色使用了该能力

## 技术实现

### 核心技术栈
- **NestJS 11.x**: 企业级 Node.js 框架
- **Fastify**: 高性能 HTTP 服务器(替代 Express)
- **TypeORM**: 数据库 ORM 框架
- **PostgreSQL**: 关系型数据库
- **nestjs-zod**: 基于 Zod 的参数验证
- **Swagger**: 自动生成 API 文档
- **TypeScript**: 类型安全的开发语言

### 项目配置特点

#### 1. Fastify 作为底层服务
```typescript
// src/main.ts
const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  new FastifyAdapter({ logger: true })
);
```

#### 2. 所有 API 使用 POST 请求 + action 路径
```
POST /api/v1/roles/action/create
POST /api/v1/roles/action/list
POST /api/v1/roles/action/get
POST /api/v1/roles/action/update
POST /api/v1/roles/action/delete
```
这种设计便于未来实现 API 权限管理。

#### 3. TypeORM + PostgreSQL
```yaml
# config/database.yaml
database:
  type: postgres
  host: localhost
  port: 5432
  username: postgres
  password: postgres
  database: ai_brain
  synchronize: true  # 开发环境自动同步表结构
```

#### 4. 配置文件策略
- **.env**: 仅存储重要配置(PORT, DB_PASSWORD)
- **YAML 文件**: 其他所有配置
  - `config/app.yaml`: 应用配置
  - `config/database.yaml`: 数据库配置

#### 5. nestjs-zod 参数验证
```typescript
// 使用 nestjs-zod 创建 DTO
import { createZodDto } from 'nestjs-zod';
import { z } from 'zod';

const CreateRoleSchema = z.object({
  name: z.string().min(1).max(100).describe('角色名称'),
  description: z.string().min(1).describe('角色描述'),
  prompt: z.string().min(1).describe('角色提示词'),
  capabilityIds: z.array(z.string().uuid()).default([]).describe('关联的能力ID列表')
});

export class CreateRoleDto extends createZodDto(CreateRoleSchema) {}

// 全局启用 ZodValidationPipe，自动验证所有请求
@Module({
  providers: [
    {
      provide: APP_PIPE,
      useClass: ZodValidationPipe
    }
  ]
})
```

#### 6. Swagger API 文档
```typescript
// 在 Controller 中使用装饰器
@ApiTags('角色管理')
@Controller('roles')
export class RolesController {
  @Post('action/create')
  @ApiOperation({ summary: '创建角色', description: '创建一个新的角色并可选关联能力' })
  @ApiResponse({ status: 201, description: '角色创建成功' })
  @ApiResponse({ status: 400, description: '参数验证失败' })
  async create(@Body() createDto: CreateRoleDto) {
    return await this.rolesService.create(createDto);
  }
}
```

访问 `http://localhost:3000/api-docs` 查看完整的交互式 API 文档。

## 项目结构

```
ai_brain/
├── config/                      # 配置文件目录
│   ├── app.yaml                # 应用配置
│   └── database.yaml           # 数据库配置
├── docs/                        # 文档目录
│   ├── 项目目标.md
│   ├── 项目说明.md
│   ├── API.md                  # API 文档
│   ├── QUICKSTART.md           # 快速开始
│   └── ARCHITECTURE.md         # 架构文档
├── src/
│   ├── common/                 # 公共模块
│   │   └── pipes/              # 自定义管道
│   │       └── zod-validation.pipe.ts
│   ├── entities/               # 数据库实体
│   │   ├── role.entity.ts
│   │   └── capability.entity.ts
│   ├── modules/                # 业务模块
│   │   ├── roles/              # 角色模块
│   │   │   ├── dto/
│   │   │   │   └── role.dto.ts
│   │   │   ├── roles.controller.ts
│   │   │   ├── roles.service.ts
│   │   │   └── roles.module.ts
│   │   └── capabilities/       # 能力模块
│   │       ├── dto/
│   │       │   └── capability.dto.ts
│   │       ├── capabilities.controller.ts
│   │       ├── capabilities.service.ts
│   │       └── capabilities.module.ts
│   ├── app.module.ts           # 主模块
│   └── main.ts                 # 入口文件
├── .env                        # 环境变量
├── package.json
└── tsconfig.json
```

## 数据库设计

### 角色表 (roles)
- id: UUID 主键
- name: 角色名称(唯一)
- description: 角色描述
- prompt: 角色提示词
- is_active: 是否激活
- created_at: 创建时间
- updated_at: 更新时间

### 能力表 (capabilities)
- id: UUID 主键
- name: 能力名称(唯一)
- description: 能力描述
- prompt: 能力提示词
- is_active: 是否激活
- created_at: 创建时间
- updated_at: 更新时间

### 角色-能力关联表 (role_capabilities)
- role_id: 角色 ID
- capability_id: 能力 ID
- 多对多关系

## 使用示例

### 创建 DBA 角色

#### 1. 创建能力
```bash
# 数据库操作能力
curl -X POST http://localhost:3000/api/v1/capabilities/action/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "数据库操作",
    "description": "执行数据库查询和操作",
    "prompt": "你可以执行 SQL 查询、分析查询性能、优化数据库操作。"
  }'

# SQL 检查能力
curl -X POST http://localhost:3000/api/v1/capabilities/action/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "SQL 检查",
    "description": "审查和验证 SQL 语句",
    "prompt": "你可以分析 SQL 语句的语法错误、安全问题和性能问题。"
  }'

# 数据库配置能力
curl -X POST http://localhost:3000/api/v1/capabilities/action/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "数据库配置",
    "description": "管理数据库配置",
    "prompt": "你可以审查和优化数据库配置参数,提升性能和安全性。"
  }'
```

#### 2. 创建 DBA 角色
```bash
curl -X POST http://localhost:3000/api/v1/roles/action/create \
  -H "Content-Type: application/json" \
  -d '{
    "name": "DBA",
    "description": "数据库管理员,具有全面的数据库管理能力",
    "prompt": "你是一名专业的数据库管理员。你擅长数据库操作、SQL 优化和配置管理。",
    "capabilityIds": ["能力1的ID", "能力2的ID", "能力3的ID"]
  }'
```

## 快速开始

1. 安装依赖:
```bash
npm install
```

2. 配置数据库:
```bash
# 创建数据库
createdb ai_brain

# 修改 config/database.yaml 中的数据库连接信息
```

3. 启动应用:
```bash
npm run start:dev
```

4. 访问 API:
```
http://localhost:3000/api/v1
```

5. 访问 Swagger API 文档:
```
http://localhost:3000/api-docs
```

## 开发命令

```bash
# 开发模式(热重载)
npm run start:dev

# 构建
npm run build

# 生产模式
npm run start:prod

# 代码格式化
npm run format

# 代码检查
npm run lint

# 测试
npm run test
```

## 后续扩展建议

1. **认证授权**: 添加 JWT 或 OAuth 认证
2. **权限管理**: 基于角色的访问控制(RBAC)
3. **缓存层**: 使用 Redis 缓存常用数据
4. **日志系统**: 完善的操作日志和审计日志
5. **API 文档**: 集成 Swagger/OpenAPI
6. **监控告警**: 添加性能监控和错误告警
7. **AI 集成**: 与实际 AI 平台对接

## 注意事项

1. **生产环境**: 将 `database.synchronize` 设置为 `false`,使用迁移管理数据库结构
2. **安全性**: 生产环境必须配置认证和授权
3. **性能**: 考虑添加数据库索引和查询优化
4. **备份**: 定期备份数据库数据
