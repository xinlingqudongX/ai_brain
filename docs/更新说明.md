# 项目更新说明

## 更新内容

### 1. 使用 nestjs-zod 替代自定义验证

**之前**: 自定义 `ZodValidationPipe`
```typescript
// 自定义实现
export class ZodValidationPipe implements PipeTransform {
  constructor(private schema: ZodSchema) {}
  transform(value: unknown) {
    // 手动验证逻辑
  }
}
```

**现在**: 使用 `nestjs-zod` 官方库
```typescript
import { createZodDto } from 'nestjs-zod';
import { z } from 'zod';

// 定义 Schema
const CreateRoleSchema = z.object({
  name: z.string().min(1).max(100).describe('角色名称'),
  description: z.string().min(1).describe('角色描述')
});

// 创建 DTO 类
export class CreateRoleDto extends createZodDto(CreateRoleSchema) {}
```

**优势**:
- 官方维护，更稳定
- 自动集成 Swagger
- 全局启用，无需每个端点单独配置
- 更好的类型推断

### 2. 集成 Swagger API 文档

**新增功能**:
- 自动生成交互式 API 文档
- 访问地址: `http://localhost:3000/api-docs`
- 支持在线测试 API

**Controller 装饰器**:
```typescript
@ApiTags('角色管理')
@Controller('roles')
export class RolesController {
  @Post('action/create')
  @ApiOperation({ summary: '创建角色', description: '创建一个新的角色' })
  @ApiResponse({ status: 201, description: '角色创建成功' })
  @ApiResponse({ status: 400, description: '参数验证失败' })
  async create(@Body() createDto: CreateRoleDto) {
    return await this.rolesService.create(createDto);
  }
}
```

**DTO 字段描述**:
```typescript
const CreateRoleSchema = z.object({
  name: z.string().min(1).max(100).describe('角色名称'),  // describe() 会显示在 Swagger 中
  description: z.string().min(1).describe('角色描述')
});
```

### 3. 全局验证配置

**app.module.ts**:
```typescript
@Module({
  providers: [
    {
      provide: APP_PIPE,
      useClass: ZodValidationPipe  // 全局启用
    }
  ]
})
export class AppModule {}
```

所有 Controller 的请求参数都会自动验证，无需单独配置。

### 4. 更新的文件

#### 删除的文件
- `src/common/pipes/zod-validation.pipe.ts` (使用 nestjs-zod 替代)

#### 修改的文件
- `src/main.ts` - 添加 Swagger 配置
- `src/app.module.ts` - 添加全局 ZodValidationPipe
- `src/modules/roles/dto/role.dto.ts` - 使用 createZodDto
- `src/modules/capabilities/dto/capability.dto.ts` - 使用 createZodDto
- `src/modules/roles/roles.controller.ts` - 添加 Swagger 装饰器
- `src/modules/capabilities/capabilities.controller.ts` - 添加 Swagger 装饰器

#### 新增的文档
- `docs/SWAGGER.md` - Swagger 使用指南
- `docs/更新说明.md` - 本文档

### 5. 新增的依赖

```json
{
  "dependencies": {
    "nestjs-zod": "^3.x",
    "@nestjs/swagger": "^7.x"
  }
}
```

## 使用方式

### 启动应用
```bash
npm run start:dev
```

### 访问 Swagger UI
```
http://localhost:3000/api-docs
```

### 测试 API
1. 在 Swagger UI 中选择 API 端点
2. 点击 "Try it out"
3. 填写请求参数
4. 点击 "Execute"
5. 查看响应结果

## 验证效果

### 参数验证
当请求参数不符合要求时，会自动返回详细的错误信息：

```json
{
  "statusCode": 400,
  "message": "Validation failed",
  "errors": [
    {
      "path": ["name"],
      "message": "String must contain at least 1 character(s)"
    }
  ]
}
```

### Swagger 文档
访问 `/api-docs` 可以看到：
- 所有 API 端点列表
- 每个端点的请求参数说明
- 响应状态码说明
- 在线测试功能

## 后续建议

1. **认证授权**: 在 Swagger 中配置 JWT 认证
2. **响应 DTO**: 为响应数据也创建 DTO 类
3. **示例数据**: 在 Swagger 中添加请求/响应示例
4. **分组优化**: 根据业务模块进一步细分 API Tag
5. **版本控制**: 考虑 API 版本管理策略

## 注意事项

1. **生产环境**: 考虑是否需要在生产环境暴露 Swagger UI
   ```typescript
   // 仅在开发环境启用 Swagger
   if (process.env.NODE_ENV !== 'production') {
     SwaggerModule.setup('api-docs', app, document);
   }
   ```

2. **性能**: Swagger 文档生成会略微增加应用启动时间

3. **安全**: 如果 API 需要认证，确保 Swagger 也配置了相应的认证方式

## 迁移指南

如果你有现有的代码使用了旧的验证方式：

### 旧方式
```typescript
@Post('action/create')
@UsePipes(new ZodValidationPipe(CreateRoleSchema))
async create(@Body() createDto: CreateRoleDto) {
  return await this.rolesService.create(createDto);
}
```

### 新方式
```typescript
// 1. 更新 DTO
export class CreateRoleDto extends createZodDto(CreateRoleSchema) {}

// 2. 移除 @UsePipes 装饰器（全局已启用）
@Post('action/create')
@ApiOperation({ summary: '创建角色' })
async create(@Body() createDto: CreateRoleDto) {
  return await this.rolesService.create(createDto);
}
```

## 参考资源

- [nestjs-zod 文档](https://github.com/risen228/nestjs-zod)
- [NestJS Swagger 文档](https://docs.nestjs.com/openapi/introduction)
- [Zod 文档](https://zod.dev/)
